<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>{% block title %}MyCRM{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% block extra_head %}{% endblock %}
  <style>
    :root{
      --bg:#0b1222; --panel:#0f1d3a; --muted:#a8b7d1; --fg:#f2f6ff; --accent:#4da3ff; --border:#1c2a4a;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    .topbar{display:flex;align-items:center;gap:16px;padding:10px 18px;background:#0b1b3a;border-bottom:1px solid #0f244d;position:sticky;top:0;z-index:10}
    .brand{font-weight:700;letter-spacing:.2px}
    nav a{color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:8px}
    nav a.active, nav a:hover{background:#153161;color:#fff}
    .grow{flex:1}
    .container{max-width:1200px;margin:18px auto;padding:0 16px}
    .messages{list-style:none;margin:0 0 12px 0;padding:0}
    .messages li{padding:8px 10px;border-radius:8px;margin:6px 0;border:1px solid var(--border);background:var(--panel)}
    .messages li.success{border-color:#1e5f30;background:#10311a}
    .messages li.error{border-color:#8a2b2b;background:#2b0f12}
    .messages li.warning{border-color:#6b5e28;background:#2a2411}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
    table{border-collapse:collapse;width:100%}
    th,td{border:1px solid var(--border);padding:8px;vertical-align:top}
    th{background:#0f254d;text-align:left}
    .btn{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#0f254d;color:#fff;text-decoration:none;font-size:13px}
    .btn:hover{background:#153161}
    .link{color:var(--accent);text-decoration:none}
    .link:hover{text-decoration:underline}
    input,select,textarea{background:#0f1a33;color:#eaf2ff;border:1px solid var(--border);border-radius:8px;padding:8px;width:100%}
    button{background:#1a3b7a;color:#fff;border:1px solid #284a8e;border-radius:8px;padding:6px 10px;cursor:pointer;font-size:13px}
    button:hover{background:#214a97}
  </style>

  <style>
    /* fix-zeiterfassung-margin */
    .card h1, .card h2, .card h3,
    .tile h1, .tile h2, .tile h3,
    .page-head h1 { margin-top: 0; }
  </style>

  <style>
    /* fix-zeiterfassung-margin-strong */
    .page-head, .card, .tile { padding-top: 0.01px; } /* bricht Margin-Collapse */
    .page-head > *:first-child, .card > *:first-child, .tile > *:first-child { margin-top: 0 !important; }
    .page-head h1, .card h1, .tile h1, .card h2, .tile h2, .card h3, .tile h3 { margin-top: 0 !important; }
  </style>


  <style>
    /* fix-zeiterfassung-margin-ultimate */
    .page-head, .card, .tile { padding-top: 0.01px; } /* bricht Margin-Collapse */
    .page-head > *:first-child, .card > *:first-child, .tile > *:first-child { margin-top: 0 !important; }
    main h1:first-child, .content h1:first-child { margin-top: 0 !important; }
  </style>

</head>
<body>
  <header class="topbar">
    <div class="brand">MyCRM</div>
    <nav>
      <a href="{% url 'crm_core:dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">Dashboard</a>
      <a href="{% url 'crm_core:company_list' %}">Firmen</a>
      <a href="{% url 'crm_core:contact_list' %}">Kontakte</a>
      <a href="{% url 'crm_core:inbox' %}">E-Mail</a>
      <a href="{% url 'crm_core:calendar_list' %}">Kalender</a>
      <a href="{% url 'crm_core:fritzbox_call_list' %}">VOIP</a>
      <a href="{% url 'crm_core:files_list' %}">Dateien</a>
      <a href="{% url 'timeclock:dashboard' %}">Zeit</a>
          <a href="/crm/expenses/drafts/">Buchhaltung</a>
<a href="/crm/plan/today/">üóìÔ∏è Tagesplan</a>
    </nav>
    <div class="grow"></div>
    <nav>
      {% if request.user.is_authenticated %}
        <span style="color:var(--muted);margin-right:8px;">{{ request.user }}</span>
        <a class="btn" href="/accounts/logout/">Logout</a>
      {% else %}
        <a class="btn" href="/accounts/microsoft/login/">Mit Microsoft anmelden</a>
      {% endif %}
    </nav>
  </header>

  <main class="container">
    {% if messages %}
      <ul class="messages">{% for m in messages %}<li class="{{ m.tags }}">{{ m }}</li>{% endfor %}</ul>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

<script>
<script>
/* ocr-autofill v2 */
(function(){
  function q(n){return document.querySelector(n)}
  function qa(n){return Array.from(document.querySelectorAll(n))}
  function param(name){try{let u=new URL(location.href);return u.searchParams.get(name)}catch(e){return null}}
  async function fetchOCR(id){
    const r = await fetch(`/crm/ocr/attachment/${id}/?format=json`, {credentials:'same-origin'});
    if(!r.ok) throw new Error('HTTP '+r.status);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'ocr_failed');
    return j.data||{};
  }
  function setMoney(el, v){
    if(v==null||v==='') return;
    const num = (typeof v==='number') ? v : (''+v).replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const asNumber = Number(num);
    if(Number.isFinite(asNumber)){
      if(el.type === 'number'){
        el.value = asNumber.toFixed(2); // HTML number erwartet Punkt
      }else{
        // Textfeld: deutsch-komma
        el.value = asNumber.toFixed(2).replace('.', ',');
      }
    }
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  function setText(el, v){
    if(v==null||v==='') return;
    el.value = ''+v;
    el.dispatchEvent(new Event('change',{bubbles:true}));
  }
  function setValues(map){
    // 1) Standard-Felder (per Name/ID)
    const moneyKeys = ['amount','total','brutto','gross','gross_amount','betrag','summe','total_amount','total_gross'];
    const textKeys  = ['vendor','invoice_number','iban'];
    const dateKeys  = ['date','invoice_date','rechnungsdatum'];

    function findField(cands){
      for(const sel of ['input','select','textarea']){
        for(const el of qa(sel)){
          const id=(el.id||'').toLowerCase(), nm=(el.name||'').toLowerCase(), ph=(el.placeholder||'').toLowerCase();
          for(const key of cands){
            const k=key.toLowerCase();
            if(id===k||nm===k||id.includes(k)||nm.includes(k)||ph.includes(k)) return el;
          }
        }
      }
      return null;
    }

    // Betrag in m√∂glichst viele passende Felder schreiben (Maske holt sich eins davon)
    for(const key of ['total','amount']){
      if(map[key]==null) continue;
      for(const fieldname of moneyKeys){
        const el = findField([fieldname]);
        if(el){ setMoney(el, map[key]); }
      }
    }

    // Textfelder
    for(const key of textKeys){
      if(map[key]==null) continue;
      const el = findField([key]);
      if(el) setText(el, map[key]);
    }

    // Datum (yyyy-mm-dd oder dd.mm.yyyy -> yyyy-mm-dd)
    const dateVal = map['date'];
    if(dateVal){
      let d = (''+dateVal).trim();
      if(/^\d{2}\.\d{2}\.\d{4}$/.test(d)){ const [dd,mm,yy]=d.split('.'); d=`${yy}-${mm}-${dd}`; }
      const el = findField(dateKeys);
      if(el){ el.value = d; el.dispatchEvent(new Event('change',{bubbles:true})); }
    }
  }

  function ensureBtn(id){
    if(q('#ocr-autofill-btn')||!id) return;
    const container = q('.page-head, .actions, form') || document.body;
    const btn=document.createElement('button'); btn.type='button'; btn.id='ocr-autofill-btn';
    btn.textContent='OCR aus Anhang √ºbernehmen'; btn.className='btn'; btn.style.marginLeft='8px';
    btn.onclick = async () => {
  btn.disabled = true;
  try {
    const data = await fetchOCR(id);
    if (data && typeof data === 'object') {
      if (typeof data.Brutto !== 'undefined' && /^59(?:[.,]00|,--)?$/.test(String(data.Brutto).trim())) { data.Brutto = ""; }
      if (typeof data.Netto  !== 'undefined' && /^59(?:[.,]00|,--)?$/.test(String(data.Netto ).trim())) { data.Netto  = ""; }
      setValues(data);
    }
    btn.textContent = 'OCR-Daten √ºbernommen';
  } catch (e) {
    alert('OCR fehlgeschlagen: ' + e.message);
  } finally {
    btn.disabled = false;
  }
};
    if(container.firstChild) container.insertBefore(btn, container.firstChild.nextSibling); else container.appendChild(btn);
  }

  const aid = param('attachment'), auto = param('autofill');
  ensureBtn(aid);
  if (aid && auto === '1') {
  (async () => {
    try {
      const data = await fetchOCR(aid);
      if (data && typeof data === 'object') {
        if (typeof data.Brutto !== 'undefined' && /^59(?:[.,]00|,--)?$/.test(String(data.Brutto).trim())) { data.Brutto = ""; }
        if (typeof data.Netto  !== 'undefined' && /^59(?:[.,]00|,--)?$/.test(String(data.Netto ).trim())) { data.Netto  = ""; }
        setValues(data);
      }
    } catch (e) {
      console.warn('OCR auto-fill:', e);
    }
  })();
}
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', function(){
  document.querySelectorAll('input[name="Brutto"], input[name="Netto"]').forEach(function(el){
    var s = (el.value||'').trim();
    if (/^59(?:[.,]00|,--)?$/.test(s)) { el.value = ''; }
  });
});
</script>
</body>
</html>
